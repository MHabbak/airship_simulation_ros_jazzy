<?xml version="1.0" ?>
<robot xmlns:xacro="http://ros.org/wiki/xacro">

  <!-- =============================================================== -->
  <!-- ==================== IMU SENSOR MACRO ======================= -->
  <!-- =============================================================== -->
  <xacro:macro name="imu_plugin_macro"
    params="namespace imu_suffix parent_link imu_topic
      mass_imu_sensor gyroscope_noise_density gyroscope_random_walk
      gyroscope_bias_correlation_time gyroscope_turn_on_bias_sigma
      accelerometer_noise_density accelerometer_random_walk
      accelerometer_bias_correlation_time accelerometer_turn_on_bias_sigma
      *inertia *origin">
    
    <!-- ✅ FIXED: Attach sensor directly to parent_link, no intermediate links -->
    <gazebo reference="${parent_link}">
      <sensor name="imu_sensor" type="imu">
        <always_on>true</always_on>
        <update_rate>250</update_rate>
        <imu>
          <angular_velocity>
            <x>
              <noise type="gaussian">
                <mean>0.0</mean>
                <stddev>${gyroscope_noise_density}</stddev>
                <bias_mean>0.0</bias_mean>
                <bias_stddev>${gyroscope_turn_on_bias_sigma}</bias_stddev>
                <dynamic_bias_stddev>${gyroscope_random_walk}</dynamic_bias_stddev>
                <dynamic_bias_correlation_time>${gyroscope_bias_correlation_time}</dynamic_bias_correlation_time>
              </noise>
            </x>
            <y>
              <noise type="gaussian">
                <mean>0.0</mean>
                <stddev>${gyroscope_noise_density}</stddev>
                <bias_mean>0.0</bias_mean>
                <bias_stddev>${gyroscope_turn_on_bias_sigma}</bias_stddev>
                <dynamic_bias_stddev>${gyroscope_random_walk}</dynamic_bias_stddev>
                <dynamic_bias_correlation_time>${gyroscope_bias_correlation_time}</dynamic_bias_correlation_time>
              </noise>
            </y>
            <z>
              <noise type="gaussian">
                <mean>0.0</mean>
                <stddev>${gyroscope_noise_density}</stddev>
                <bias_mean>0.0</bias_mean>
                <bias_stddev>${gyroscope_turn_on_bias_sigma}</bias_stddev>
                <dynamic_bias_stddev>${gyroscope_random_walk}</dynamic_bias_stddev>
                <dynamic_bias_correlation_time>${gyroscope_bias_correlation_time}</dynamic_bias_correlation_time>
              </noise>
            </z>
          </angular_velocity>
          <linear_acceleration>
            <x>
              <noise type="gaussian">
                <mean>0.0</mean>
                <stddev>${accelerometer_noise_density}</stddev>
                <bias_mean>0.0</bias_mean>
                <bias_stddev>${accelerometer_turn_on_bias_sigma}</bias_stddev>
                <dynamic_bias_stddev>${accelerometer_random_walk}</dynamic_bias_stddev>
                <dynamic_bias_correlation_time>${accelerometer_bias_correlation_time}</dynamic_bias_correlation_time>
              </noise>
            </x>
            <y>
              <noise type="gaussian">
                <mean>0.0</mean>
                <stddev>${accelerometer_noise_density}</stddev>
                <bias_mean>0.0</bias_mean>
                <bias_stddev>${accelerometer_turn_on_bias_sigma}</bias_stddev>
                <dynamic_bias_stddev>${accelerometer_random_walk}</dynamic_bias_stddev>
                <dynamic_bias_correlation_time>${accelerometer_bias_correlation_time}</dynamic_bias_correlation_time>
              </noise>
            </y>
            <z>
              <noise type="gaussian">
                <mean>0.0</mean>
                <stddev>${accelerometer_noise_density}</stddev>
                <bias_mean>0.0</bias_mean>
                <bias_stddev>${accelerometer_turn_on_bias_sigma}</bias_stddev>
                <dynamic_bias_stddev>${accelerometer_random_walk}</dynamic_bias_stddev>
                <dynamic_bias_correlation_time>${accelerometer_bias_correlation_time}</dynamic_bias_correlation_time>
              </noise>
            </z>
          </linear_acceleration>
        </imu>
        <plugin filename="gz-sim-imu-system" name="gz::sim::systems::Imu">
          <initial_orientation_as_reference>false</initial_orientation_as_reference>
        </plugin>
      </sensor>
    </gazebo>
  </xacro:macro>

  <!-- =============================================================== -->
  <!-- ==================== GPS SENSOR MACRO ======================= -->
  <!-- =============================================================== -->
  <xacro:macro name="gps_plugin_macro"
    params="namespace gps_suffix parent_link gps_topic ground_speed_topic
      mass_gps_sensor horizontal_pos_std_dev vertical_pos_std_dev
      horizontal_vel_std_dev vertical_vel_std_dev *inertia *origin">
    
    <!-- ✅ FIXED: Attach sensor directly to parent_link, no intermediate links -->
    <gazebo reference="${parent_link}">
      <sensor name="navsat_sensor" type="navsat">
        <always_on>true</always_on>
        <update_rate>10.0</update_rate>
        <navsat>
          <position_sensing>
            <horizontal>
              <noise type="gaussian">
                <mean>0.0</mean>
                <stddev>${horizontal_pos_std_dev}</stddev>
              </noise>
            </horizontal>
            <vertical>
              <noise type="gaussian">
                <mean>0.0</mean>
                <stddev>${vertical_pos_std_dev}</stddev>
              </noise>
            </vertical>
          </position_sensing>
          <velocity_sensing>
            <horizontal>
              <noise type="gaussian">
                <mean>0.0</mean>
                <stddev>${horizontal_vel_std_dev}</stddev>
              </noise>
            </horizontal>
            <vertical>
              <noise type="gaussian">
                <mean>0.0</mean>
                <stddev>${vertical_vel_std_dev}</stddev>
              </noise>
            </vertical>
          </velocity_sensing>
        </navsat>
        <plugin filename="gz-sim-navsat-system" name="gz::sim::systems::NavSat">
        </plugin>
      </sensor>
    </gazebo>
  </xacro:macro>

  <!-- =============================================================== -->
  <!-- =============== MAGNETOMETER SENSOR MACRO =================== -->
  <!-- =============================================================== -->
  <xacro:macro name="magnetometer_plugin_macro"
    params="namespace magnetometer_suffix parent_link magnetometer_topic
      mass_magnetometer_sensor noise_density *inertia *origin">
    
    <!-- ✅ FIXED: Attach sensor directly to parent_link, no intermediate links -->
    <gazebo reference="${parent_link}">
      <sensor name="mag_sensor" type="magnetometer">
        <always_on>true</always_on>
        <update_rate>50</update_rate>
        <magnetometer>
          <x>
            <noise type="gaussian">
              <mean>0.0</mean>
              <stddev>${noise_density}</stddev>
            </noise>
          </x>
          <y>
            <noise type="gaussian">
              <mean>0.0</mean>
              <stddev>${noise_density}</stddev>
            </noise>
          </y>
          <z>
            <noise type="gaussian">
              <mean>0.0</mean>
              <stddev>${noise_density}</stddev>
            </noise>
          </z>
        </magnetometer>
        <plugin filename="gz-sim-magnetometer-system" name="gz::sim::systems::Magnetometer">
        </plugin>
      </sensor>
    </gazebo>
  </xacro:macro>

  <!-- =============================================================== -->
  <!-- =============== PRESSURE SENSOR MACRO ======================= -->
  <!-- =============================================================== -->
  <xacro:macro name="pressure_sensor_plugin_macro"
    params="namespace pressure_suffix parent_link pressure_topic
      mass_pressure_sensor noise_density *inertia *origin">
    
    <!-- ✅ FIXED: Attach sensor directly to parent_link, no intermediate links -->
    <gazebo reference="${parent_link}">
      <sensor name="air_pressure_sensor" type="air_pressure">
        <always_on>true</always_on>
        <update_rate>50</update_rate>
        <air_pressure>
          <reference_altitude>341</reference_altitude>
          <noise type="gaussian">
            <mean>0.0</mean>
            <stddev>${noise_density}</stddev>
          </noise>
        </air_pressure>
        <plugin filename="gz-sim-air-pressure-system" name="gz::sim::systems::AirPressure">
        </plugin>
      </sensor>
    </gazebo>
  </xacro:macro>

  <!-- =============================================================== -->
  <!-- ==================== ODOMETRY MACRO ========================= -->
  <!-- =============================================================== -->
  <xacro:macro name="odometry_plugin_macro"
    params="namespace odometry_sensor_suffix parent_link pose_topic 
      pose_with_covariance_topic position_topic transform_topic odometry_topic
      parent_frame_id child_frame_id mass_odometry_sensor measurement_divisor
      measurement_delay unknown_delay noise_normal_position noise_normal_quaternion
      noise_normal_linear_velocity noise_normal_angular_velocity noise_uniform_position
      noise_uniform_quaternion noise_uniform_linear_velocity noise_uniform_angular_velocity
      enable_odometry_map odometry_map image_scale *inertia *origin">
    
    <!-- ✅ ROS2 Odometry (separate from PX4 sensor discovery) -->
    <gazebo reference="${parent_link}">
      <plugin filename="gz-sim-odometry-publisher-system" name="gz::sim::systems::OdometryPublisher">
        <ros>
          <namespace>${namespace}</namespace>
          <remapping>~/out:=${odometry_topic}</remapping>
        </ros>
        <odom_frame>${parent_frame_id}</odom_frame>
        <robot_base_frame>${child_frame_id}</robot_base_frame>
        <odom_publish_frequency>100</odom_publish_frequency>
        <odom_covariance_x>0.0001</odom_covariance_x>
        <odom_covariance_y>0.0001</odom_covariance_y>
        <odom_covariance_yaw>0.01</odom_covariance_yaw>
      </plugin>
    </gazebo>
  </xacro:macro>

  <!-- =============================================================== -->
  <!-- ==================== CONVENIENCE MACROS ==================== -->
  <!-- =============================================================== -->
  
  <xacro:macro name="ground_truth_imu_and_odometry" params="namespace parent_link">
    <!-- Mount an IMU providing ground truth. -->
    <xacro:imu_plugin_macro
      namespace="${namespace}"
      imu_suffix="_gt"
      parent_link="${parent_link}"
      imu_topic="ground_truth/imu"
      mass_imu_sensor="0.00001"
      gyroscope_noise_density="0.0"
      gyroscope_random_walk="0.0"
      gyroscope_bias_correlation_time="1000.0"
      gyroscope_turn_on_bias_sigma="0.0"
      accelerometer_noise_density="0.0"
      accelerometer_random_walk="0.0"
      accelerometer_bias_correlation_time="300.0"
      accelerometer_turn_on_bias_sigma="0.0">
      <inertia ixx="0.00001" ixy="0.0" ixz="0.0" iyy="0.00001" iyz="0.0" izz="0.00001" />
      <origin xyz="0 0 0" rpy="0 0 0" />
    </xacro:imu_plugin_macro>

    <!-- Mount a generic odometry sensor providing ground truth. -->
    <xacro:odometry_plugin_macro
      namespace="${namespace}"
      odometry_sensor_suffix="_gt"
      parent_link="${parent_link}"
      pose_topic="ground_truth/pose"
      pose_with_covariance_topic="ground_truth/pose_with_covariance"
      position_topic="ground_truth/position"
      transform_topic="ground_truth/transform"
      odometry_topic="ground_truth/odometry"
      parent_frame_id="world"
      child_frame_id="base_link"
      mass_odometry_sensor="0.00001"
      measurement_divisor="1"
      measurement_delay="0"
      unknown_delay="0.0"
      noise_normal_position="0 0 0"
      noise_normal_quaternion="0 0 0"
      noise_normal_linear_velocity="0 0 0"
      noise_normal_angular_velocity="0 0 0"
      noise_uniform_position="0 0 0"
      noise_uniform_quaternion="0 0 0"
      noise_uniform_linear_velocity="0 0 0"
      noise_uniform_angular_velocity="0 0 0"
      enable_odometry_map="false"
      odometry_map=""
      image_scale="">
      <inertia ixx="0.00001" ixy="0.0" ixz="0.0" iyy="0.00001" iyz="0.0" izz="0.00001" />
      <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0" />
    </xacro:odometry_plugin_macro>
  </xacro:macro>

  <xacro:macro name="tail_imu_and_odometry" params="namespace parent_link">
    <!-- Mount an IMU for tail. -->
    <xacro:imu_plugin_macro
      namespace="${namespace}"
      imu_suffix="_tail"
      parent_link="${parent_link}"
      imu_topic="tail/imu"
      mass_imu_sensor="0.00001"
      gyroscope_noise_density="0.0"
      gyroscope_random_walk="0.0"
      gyroscope_bias_correlation_time="1000.0"
      gyroscope_turn_on_bias_sigma="0.0"
      accelerometer_noise_density="0.0"
      accelerometer_random_walk="0.0"
      accelerometer_bias_correlation_time="300.0"
      accelerometer_turn_on_bias_sigma="0.0">
      <inertia ixx="0.00001" ixy="0.0" ixz="0.0" iyy="0.00001" iyz="0.0" izz="0.00001" />
      <origin xyz="0 0 0" rpy="${pi} 0 0" />
    </xacro:imu_plugin_macro>

    <!-- Mount a generic odometry sensor for tail. -->
    <xacro:odometry_plugin_macro
      namespace="${namespace}"
      odometry_sensor_suffix="_tail"
      parent_link="${parent_link}"
      pose_topic="tail/pose"
      pose_with_covariance_topic="tail/pose_with_covariance"
      position_topic="tail/position"
      transform_topic="tail/transform"
      odometry_topic="tail/odometry"
      parent_frame_id="world"
      child_frame_id="${parent_link}"
      mass_odometry_sensor="0.00001"
      measurement_divisor="1"
      measurement_delay="0"
      unknown_delay="0.0"
      noise_normal_position="0 0 0"
      noise_normal_quaternion="0 0 0"
      noise_normal_linear_velocity="0 0 0"
      noise_normal_angular_velocity="0 0 0"
      noise_uniform_position="0 0 0"
      noise_uniform_quaternion="0 0 0"
      noise_uniform_linear_velocity="0 0 0"
      noise_uniform_angular_velocity="0 0 0"
      enable_odometry_map="false"
      odometry_map=""
      image_scale="">
      <inertia ixx="0.00001" ixy="0.0" ixz="0.0" iyy="0.00001" iyz="0.0" izz="0.00001" />
      <origin xyz="0.0 0.0 0.0" rpy="${pi} 0.0 0.0" />
    </xacro:odometry_plugin_macro>
  </xacro:macro>

  <!-- ✅ PRIMARY FLIGHT CONTROL SENSORS (attach directly to parent_link) -->
  <xacro:macro name="default_imu" params="namespace parent_link">
    <!-- ADIS16448 IMU for PX4 flight control -->
    <xacro:imu_plugin_macro
      namespace="${namespace}"
      imu_suffix=""
      parent_link="${parent_link}"
      imu_topic="imu"
      mass_imu_sensor="0.015"
      gyroscope_noise_density="0.0003394"
      gyroscope_random_walk="0.000038785"
      gyroscope_bias_correlation_time="1000.0"
      gyroscope_turn_on_bias_sigma="0.0087"
      accelerometer_noise_density="0.004"
      accelerometer_random_walk="0.006"
      accelerometer_bias_correlation_time="300.0"
      accelerometer_turn_on_bias_sigma="0.1960">
      <inertia ixx="0.00001" ixy="0.0" ixz="0.0" iyy="0.00001" iyz="0.0" izz="0.00001" />
      <origin xyz="0 0 0" rpy="0 0 0" />
    </xacro:imu_plugin_macro>
  </xacro:macro>

  <xacro:macro name="default_gps" params="namespace parent_link">
    <!-- GPS for PX4 navigation -->
    <xacro:gps_plugin_macro
      namespace="${namespace}"
      gps_suffix=""
      parent_link="${parent_link}"
      gps_topic="gps"
      ground_speed_topic="ground_speed"
      mass_gps_sensor="0.015"
      horizontal_pos_std_dev="3.0"
      vertical_pos_std_dev="6.0"
      horizontal_vel_std_dev="0.1"
      vertical_vel_std_dev="0.1">
      <inertia ixx="0.00001" ixy="0.0" ixz="0.0" iyy="0.00001" iyz="0.0" izz="0.00001" />
      <origin xyz="0 0 0" rpy="0 0 0" />
    </xacro:gps_plugin_macro>
  </xacro:macro>

  <xacro:macro name="default_magnetometer" params="namespace parent_link">
    <!-- Magnetometer for PX4 heading estimation -->
    <xacro:magnetometer_plugin_macro
      namespace="${namespace}"
      magnetometer_suffix=""
      parent_link="${parent_link}"
      magnetometer_topic="magnetic_field"
      mass_magnetometer_sensor="0.005"
      noise_density="0.0004">
      <inertia ixx="0.00001" ixy="0.0" ixz="0.0" iyy="0.00001" iyz="0.0" izz="0.00001" />
      <origin xyz="0 0 0" rpy="0 0 0" />
    </xacro:magnetometer_plugin_macro>
  </xacro:macro>

  <xacro:macro name="default_pressure_sensor" params="namespace parent_link">
    <!-- Barometer for PX4 altitude estimation -->
    <xacro:pressure_sensor_plugin_macro
      namespace="${namespace}"
      pressure_suffix=""
      parent_link="${parent_link}"
      pressure_topic="air_pressure"
      mass_pressure_sensor="0.005"
      noise_density="0.01">
      <inertia ixx="0.00001" ixy="0.0" ixz="0.0" iyy="0.00001" iyz="0.0" izz="0.00001" />
      <origin xyz="0 0 0" rpy="0 0 0" />
    </xacro:pressure_sensor_plugin_macro>
  </xacro:macro>

</robot>